<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <title>任务提交</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-light bg-light justify-content-between px-3">
  <span class="navbar-brand mb-0 h1">压力测试平台</span>
  <div>
    <a href="{{ url_for('task_list') }}" class="me-3">任务列表</a>
    {% if role == 'admin' %}<a href="{{ url_for('admin') }}" class="me-3">管理后台</a>{% endif %}
    <a href="{{ url_for('logout') }}">退出</a>
  </div>
</nav>
<div class="container py-4">
  {% if message %}<div class="alert alert-info">{{ message }}</div>{% endif %}
  {% for msg in get_flashed_messages() %}<div class="alert alert-danger">{{ msg }}</div>{% endfor %}
  <form method="post" class="row g-3">
    <div class="col-12">
      <label class="form-label">目标地址（每行一个）</label>
      <textarea name="targets" class="form-control" rows="4" placeholder="example.com"></textarea>
    </div>
    <div class="col-md-4">
      <label class="form-label">攻击层级</label>
      <select name="layer" id="layer" class="form-select">
        <option value="L4">L4</option>
        <option value="L7">L7</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">并发数：<span id="ccur">1</span></label>
      <input type="range" name="concurrency" id="concurrency" class="form-range" min="1" max="{{ max_concurrency }}" value="1">
    </div>
    <div class="col-md-4">
      <label class="form-label">时长：<span id="cdur">1</span>s</label>
      <input type="range" name="duration" id="duration" class="form-range" min="1" max="{{ max_duration }}" value="1">
    </div>
    <div class="col-md-4">
      <label class="form-label">攻击方法</label>
      <select name="method" id="method" class="form-select"></select>
    </div>
    <div class="col-12">
      <button type="submit" class="btn btn-primary">提交任务</button>
      <span class="ms-3 text-muted">当前排队：{{ queue_len }} 个任务</span>
    </div>
  </form>
</div>
<script>
const layerMethods = {{ layer_methods|tojson }};
function updateMethods(){
  const layer = document.getElementById('layer').value;
  const msel = document.getElementById('method');
  msel.innerHTML = '';
  layerMethods[layer].forEach(m=>{
    const op = document.createElement('option');
    op.value = m; op.textContent = m; msel.appendChild(op);
  });
}
updateMethods();
document.getElementById('layer').addEventListener('change', updateMethods);
const rngC = document.getElementById('concurrency');
const spanC = document.getElementById('ccur');
rngC.addEventListener('input', ()=> spanC.textContent = rngC.value);
const rngD = document.getElementById('duration');
const spanD = document.getElementById('cdur');
rngD.addEventListener('input', ()=> spanD.textContent = rngD.value);
</script>
</body>
</html>
